# Monolog コーディングスタイルルール定義
# このファイルはAIコーチシステムが参照するルールベースです

project:
  name: "monolog/monolog"
  type: "library"
  php_version: ">=8.1"
  psr_compliance:
    - "PSR-2"
    - "PSR-3"
    - "PSR-4"

# 必須のコーディングルール
mandatory_rules:
  
  file_structure:
    - rule: "strict_types_declaration"
      description: "すべてのPHPファイルの先頭でdeclare(strict_types=1)を宣言"
      example: "<?php declare(strict_types=1);"
      severity: "error"
      points: 10
      
    - rule: "file_header_comment"
      description: "統一されたライセンスヘッダーコメント"
      template: |
        /*
         * This file is part of the [Project] package.
         *
         * (c) [Author] <email>
         *
         * For the full copyright and license information, please view the LICENSE
         * file that was distributed with this source code.
         */
      severity: "warning"
      points: 5
      
    - rule: "namespace_blank_line"
      description: "namespace宣言の前に必ず空行を1行入れる"
      severity: "warning"
      points: 3

  arrays:
    - rule: "short_array_syntax"
      description: "配列は [] 構文を使用、array() は禁止"
      good_example: "$arr = ['a', 'b', 'c'];"
      bad_example: "$arr = array('a', 'b', 'c');"
      severity: "error"
      points: 5
      
    - rule: "trailing_comma_multiline"
      description: "複数行の配列は末尾にカンマを付ける"
      good_example: |
        $config = [
            'key1' => 'value1',
            'key2' => 'value2',
        ];
      severity: "warning"
      points: 3
      
    - rule: "no_trailing_comma_singleline"
      description: "単一行の配列は末尾カンマ禁止"
      bad_example: "$arr = ['a', 'b',];"
      severity: "warning"
      points: 3

  type_system:
    - rule: "type_hints_mandatory"
      description: "すべての関数引数と戻り値に型ヒントを指定"
      good_example: "public function getName(): string"
      bad_example: "public function getName()"
      severity: "error"
      points: 10
      
    - rule: "property_types"
      description: "クラスプロパティに型宣言を追加"
      good_example: "protected string $name;"
      bad_example: "protected $name;"
      severity: "error"
      points: 8
      
    - rule: "union_types"
      description: "PHP 8.0+ Union型を適切に使用"
      good_example: "DateTimeZone|null $timezone"
      severity: "info"
      points: 5
      
    - rule: "phpstan_annotations"
      description: "PHPでは表現できない型情報はPHPDocで補完"
      good_example: |
        /**
         * @var list<HandlerInterface>
         */
        protected array $handlers;
      severity: "info"
      points: 5

  spacing:
    - rule: "indentation"
      description: "インデントはスペース4つ、タブ禁止"
      severity: "error"
      points: 5
      
    - rule: "cast_spaces"
      description: "キャストの後に単一スペース"
      good_example: "$int = (int) $value;"
      bad_example: "$int = (int)$value;"
      severity: "warning"
      points: 2
      
    - rule: "object_operator_spacing"
      description: "オブジェクト演算子(->)の前後にスペースなし"
      good_example: "$this->name"
      bad_example: "$this -> name"
      severity: "error"
      points: 3
      
    - rule: "blank_line_before_statement"
      description: "return, throw, try, continue, declareの前に空行"
      severity: "warning"
      points: 3

  functions:
    - rule: "native_function_fqn"
      description: "ネイティブ関数は完全修飾名で呼び出し"
      good_example: "\\count($array)"
      bad_example: "count($array)"
      reason: "パフォーマンス向上のため"
      severity: "warning"
      points: 3
      
    - rule: "method_chaining"
      description: "設定メソッドは $this を返してチェーン可能に"
      good_example: |
        public function setName(string $name): self
        {
            $this->name = $name;
            return $this;
        }
      severity: "info"
      points: 5

  imports:
    - rule: "no_unused_imports"
      description: "使用していないuse文は削除"
      severity: "warning"
      points: 3
      
    - rule: "no_leading_slash"
      description: "use文の先頭にバックスラッシュなし"
      severity: "error"
      points: 2
      
    - rule: "import_ordering"
      description: "use文はアルファベット順にソート"
      severity: "info"
      points: 2

  classes:
    - rule: "no_blank_after_class_opening"
      description: "クラス開始波括弧の直後に空行なし"
      severity: "warning"
      points: 2
      
    - rule: "method_separation"
      description: "メソッド間に1行の空行"
      severity: "warning"
      points: 2
      
    - rule: "visibility_required"
      description: "すべてのプロパティとメソッドにvisibilityキーワード"
      severity: "error"
      points: 5

  phpdoc:
    - rule: "phpdoc_alignment"
      description: "PHPDocのタグを揃える"
      severity: "info"
      points: 2
      
    - rule: "phpdoc_order"
      description: "PHPDocのタグを標準順序で記述"
      order: ["@param", "@return", "@throws"]
      severity: "info"
      points: 2
      
    - rule: "no_superfluous_phpdoc"
      description: "型ヒントで明らかな情報はPHPDocに書かない"
      exception: "混合型や複雑な型は記述"
      severity: "info"
      points: 3
      
    - rule: "phpdoc_no_package"
      description: "@packageタグは使用しない"
      severity: "warning"
      points: 2

  comparison:
    - rule: "strict_comparison"
      description: "厳密比較 (===, !==) を使用"
      severity: "warning"
      points: 5
      
    - rule: "standardize_not_equals"
      description: "不等号は !== を使用、<> は禁止"
      good_example: "if ($value !== null)"
      bad_example: "if ($value <> null)"
      severity: "error"
      points: 3

  whitespace:
    - rule: "no_extra_blank_lines"
      description: "余分な空行を削除"
      severity: "warning"
      points: 2
      
    - rule: "no_blank_lines_after_phpdoc"
      description: "PHPDocの直後に空行なし"
      severity: "warning"
      points: 2
      
    - rule: "no_whitespace_in_blank_line"
      description: "空行に空白文字なし"
      severity: "info"
      points: 1

# 推奨されるベストプラクティス
best_practices:
  
  design_patterns:
    - pattern: "Strategy Pattern"
      usage: "Handlerインターフェースと複数の実装"
      benefit: "拡張性が高い"
      
    - pattern: "Chain of Responsibility"
      usage: "Handlerのスタック処理"
      benefit: "柔軟なログ処理フロー"
      
    - pattern: "Decorator Pattern"
      usage: "Processorによるレコード加工"
      benefit: "機能の動的追加"

  error_handling:
    - rule: "appropriate_exceptions"
      exceptions:
        logic_error: "\\LogicException"
        invalid_argument: "\\InvalidArgumentException"
        runtime_error: "\\UnexpectedValueException"
        psr_log: "Psr\\Log\\InvalidArgumentException"
      
    - rule: "exception_messages"
      description: "例外メッセージは具体的かつ有用な情報を含む"
      good_example: "throw new \\InvalidArgumentException('Level \"'.$level.'\" is not defined');"
      
    - rule: "error_context"
      description: "可能な限り例外にコンテキスト情報を追加"

  naming_conventions:
    classes: "PascalCase"
    methods: "camelCase"
    properties: "camelCase"
    constants: "UPPER_SNAKE_CASE"
    interfaces: "PascalCase + Interface suffix"
    traits: "PascalCase"
    
  method_design:
    - rule: "single_responsibility"
      description: "1つのメソッドは1つの責任"
      max_lines: 30
      
    - rule: "low_complexity"
      description: "循環的複雑度を低く保つ"
      max_complexity: 10
      
    - rule: "meaningful_names"
      description: "メソッド名は動詞で始まり、目的を明確に示す"
      examples:
        - "getName()"
        - "pushHandler()"
        - "isHandling()"

  testing:
    - rule: "test_coverage"
      description: "すべてのpublicメソッドにテストを書く"
      target_coverage: 80
      
    - rule: "test_naming"
      description: "テストメソッド名はtestプレフィックス + 説明的な名前"
      example: "testGetName()"
      
    - rule: "test_organization"
      description: "テストクラスはMonologTestCaseを継承"
      
    - rule: "covers_annotation"
      description: "@coversアノテーションでカバレッジを明示"
      example: "@covers Logger::getName"

# 静的解析設定
static_analysis:
  tool: "PHPStan"
  level: 8
  strict_rules: true
  bleeding_edge: true
  treat_phpdoc_as_certain: false
  
  additional_rules:
    - "phpstan-strict-rules"
    - "phpstan-deprecation-rules"

# コード品質メトリクス目標値
quality_metrics:
  cyclomatic_complexity:
    max_per_method: 10
    max_per_class: 50
    
  cognitive_complexity:
    max_per_method: 15
    
  lines_of_code:
    max_per_method: 50
    max_per_class: 500
    
  maintainability_index:
    min_score: 70

# 評価基準のウェイト
scoring_weights:
  coding_standards: 25  # コーディング規約遵守
  readability: 25       # 可読性
  maintainability: 25   # 保守性
  efficiency: 25        # 効率性

# レベル別の必須知識
level_requirements:
  
  level_1_beginner:
    - "strict_types宣言"
    - "短い配列構文"
    - "基本的な型ヒント"
    - "PSR-2の基本"
    
  level_2_elementary:
    - "すべてのルールでstrict_types"
    - "プロパティの型宣言"
    - "PHPDocの基本"
    
  level_3_pre_intermediate:
    - "完全な型ヒント"
    - "適切なvisibility"
    - "例外の使い分け"
    
  level_4_intermediate:
    - "インターフェース設計"
    - "Union型の活用"
    - "PHPStan Level 4通過"
    
  level_5_upper_intermediate:
    - "デザインパターンの実装"
    - "高度なPHPDocアノテーション"
    - "PHPStan Level 6通過"
    
  level_6_advanced_intermediate:
    - "ジェネリクス風の型表現"
    - "SOLID原則の実践"
    - "テストカバレッジ80%以上"
    
  level_7_pre_advanced:
    - "複雑なデザインパターン"
    - "パフォーマンス最適化"
    - "PHPStan Level 8通過"
    
  level_8_advanced:
    - "アーキテクチャ設計"
    - "WeakMap等の高度な機能"
    - "防御的プログラミング"
    
  level_9_expert:
    - "Fiberを使った非同期処理"
    - "複雑な型システム設計"
    - "プロジェクト全体の設計"
    
  level_10_master:
    - "チーム固有のアーキテクチャ完全理解"
    - "コードレビュー能力"
    - "新規パターンの提案能力"

